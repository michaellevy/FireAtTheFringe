---
title: "Empirical parameterization of agent behavior for a coupled model of fire in the wildland-urban interface"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: pdf_document
bibliography: fireFringe.bib
---

```{r setup, include = FALSE}
library(rethinking)
library(dplyr)
library(tidyr)
library(ggplot2)
theme_set(new = theme_bw())
d = readRDS('../data/derived/dataVImodel.RDS') %>% as.data.frame()
knitr::opts_chunk$set(fig.pos = 'H!', echo = FALSE, results = "hide", warning = FALSE)
```

## Introduction

### Broad Justification: WUI fire is a problem and we need models that include society (Katie)

Already a problem, getting worse with climate change, DS behavior matters for the owner and broader fire patterns, therefore we need models that include homeowner behavior.

### ABM Justification (Patrick)

Most models omit humans, econ models of behavior assume rational self-interest but that fails to capture key dynamics in collective action challenges like this. ABMs to the rescue: can capture social dynamics with agents responding to each other and can capture biophysical -> social feedback with agents responding to events in their environment.

### Broad overview of our larger endeavor (Kenny?)

- Set out to build coupled model of fire and society. 
- Located in San Diego because fire is big problem, potential for action, etc
- Full model situates homeowners on the landscape, simulates ignition and spread w/ homeowners responsive to social environment and fire experience, etc.
    - DS behavior empirically parameterized based on survey responses

Here, we do not aim to document the complete mechanics of the agent-based model. That description is forthcoming and will comply with the ODD protocol (cite). Here, we describe the motivation for, mechanics of, and findings from an empirical parameterization of agent-behavior for a CHANS model. The parameterization is based on survey data and employs a Bayesian, multi-level model that quantifies and preserves uncertainty in human behavior and provides a natural, principled mechanism for generating agents.

## Background

### Description of the system (Kenny)

Don't want to spend too much time here, but a paragraph on the SD WUI's salient features, especially the town structure, fire dynamics. Previous findings from this survey.

### What is known about the drivers of DS behavior (Katie)

Anything that can be said about social influences and influence of experience with fire is extra great.

### Getting behavior into an ABM (Patrick)

Lots of handwaving historically, cite calls for need for empirical parameterization. 

Maybe something here about ways empirical parameterization has been done and how those don't fit with most research in Katie and Kenny's community. We wanted to take insights from all this work that's been done on human fire behavior and apply that to agent beahvior, e.g. in our construction of aggregated predictors.

### Why a multi-level model (Mike)

Heterogeniety in behavior at town-level, don't want to ignore, but fixed effects over-learn. Pooling is awesome, quantifies uncertainty incorporating sample size, so we can do something principled in towns where we have few observations. Cite predictive benefits.

Generative aspect: Is there anything unique about Bayesian here? Don't have to make distributional assumption about posterior. 

### How we'll use the statistical model in the ABM (Mike)

- Q: Have we pinned down what decisions we want agents making at each timestep?  Do we ever add new agents? Do we want existing homes to be able to decrease their DS behavior, or only add?



## Methods

### Data details (Kenny)

Survey collection, briefly, cite original paper.


To empirically parameterize homeowner-agent behavior, we conditioned a multi-level Bayesian statistical model on data from 637 homeowner survey respondents. We then use the model to generate new households drawn from the distribution implied by the model. The outcome variable of the model is the number of defensible space practices adopted by each homeowner, which we instantiate as a binomially distributed process. The model contains varying intercepts at the level of town ($\alpha_{town}$), which allows the model to pool information across towns in determining the base adoption rate and models the effect of social forces on homeowner behavior. Experience with fire is included as a predictor as the natural logarithm of the distance of the home from recent fires ($D$). Three additional predictors were constructed from survey responses to charactarize the psychological makeup of homeowners: policy beliefs ($P$), beliefs about the effectiveness of defensible space practices ($E$), and beliefs about risk associated with wildfire ($R$). We employed weakly regularizing prior, $\mathcal{N}(0, 1)$, for all four continuous predictors to reign-in overfitting. The model takes the form:

$$
\begin{aligned}
N_i &\sim binomial(4, p_i) \\
logit(p_i) &= \alpha_{town[i]} + \beta_{P} P + \beta_{E} E + \beta_{R} R + \beta_{D} ln(D) \\
\alpha_{town} &\sim Normal(\alpha, \sigma) \\
\alpha &\sim Normal(0.5, 1) \\
\sigma &\sim HalfCauchy(0, 2) \\
\beta_{P} &\sim Normal(0, 1) \\
\beta_{E} &\sim Normal(0, 1) \\
\beta_{R} &\sim Normal(0, 1) \\
\beta_{D} &\sim Normal(0, 1). \\
\end{aligned}
$$

All analyses were performed in R version 3.3.1 [@r_core_team_r:_2016]. For statistical modeling, we used the rethinking package [@mcelreath_rethinking:_2015] which samples posterior distributions using Hamiltonian Monte Carlo via Stan [@stan_development_team_stan:_2015]. The full reproducability suite of data and code are available in a repository at XXX (xxx.com). 

Bayesian models are generative, and we now describe how we can use the model to generate new agent-households. For any set of predictor values, there is an implied distribution of defensible space behaviors. This distribution is generated by drawing (1,000) samples of parameter values from the model's joint posterior distribution, multiplying the vectors of paramter values by a vector of predictor values to obtain a distribution of $p$ values, which are then used in binomial trials to generate a distribution of number of defensible space behaviors. Note the two levels of stochasticity in this process: 1 in drawing parameters from the joint posterior distribution and another in the binomial trials for each $p$. This preserves uncertainty around defensible space behavior. There is a large stochastic element to how many behaviors a given household will implement, and this method quantifies and preserves the uncertainty in that stochasticity. 

This process works for any set of predictor values. In a presumed-stationary world, we could generate new agents from the observed sets of predictor values or a multivariate distribution parameterized from the observed data. To test the effects of interventions, we could modulate the values of specific predictors, for example, increasing the values of effectiveness of defensible space behavior by some fixed or random value to understand how an education-outreach effort might work. The varying intercepts aspect of the model also opens the possibility of generating new towns in a princpled manner, as long as we are willing to posit that the new towns come from the same distribution as the observed towns. To do so, we draw values of $\alpha_{town}$s from the posterior distribution of $\alpha$.


## Results

### Summary Statistics

Figure 1 shows the distribution of number of defensible space behaviors, out of four possible, adopted per household by town. Across all towns, the modal number of behaviors adopted is four,the median is two, and the mean `r round(mean(d$numBehaviors), 2)`. Figure 1 also shows the number of survey responses in our dataset from each town, which are roughly proportional to the number of homes in the WUI in each town.

```{r, fig.height = 4.5, echo = FALSE, fig.cap = "Number of defensible space behaviors adopted by town. Tile heights are proportional to the number of survey respondents per town, and widths are proportional to the number of people in that town having adopted that many behvaiors."}
# ggplot(d, aes(fill = as.factor(numBehaviors), 
#               x = reorder(city, city, function(x) length(x)))) + 
#   geom_bar() + 
#   scale_fill_discrete(guide = guide_legend(title = "Number Bevahiors", reverse = TRUE)) +
#   xlab("Town") +
#   ylab("Number of households")
# 
# head(d$city)
# d$city = factor(d$city, levels = levels(reorder(d$city, d$city, function(x) length(x))))
# ggplot(d, aes(x = numBehaviors)) + 
#   geom_histogram(bins = 5) +
#   facet_wrap(~ city)
# 
# ggplot(d, aes(x = numBehaviors, fill = city)) + 
#   geom_bar(position = "dodge")

mosaicplot(table(reorder(d$city, d$numBehaviors, mean), 
           factor(d$numBehaviors, levels = 4:0)), 
     main = "", color = TRUE, dir = c("h", "v"),
     las = 1)
```

### Model Coefficients

Table 1 presents parameter values and 95% credibility intervals for each of the predictors in the model. Belief in the effectiveness of defensible space behaviors is a strong positive predictor of implementation of defensible space behavior. Policy beliefs, which is an aggregate measure capturing ???, and perceived risk associated with wildfire are both negatively associated with defensible space adoption, but there is ambiguity around those relationships. Individuals who are closer to recent fires tend to have adopted more defensible space behavior, but this relationship also has significant uncertainty. There is substantial town-to-town variability in the base-rate of adoption: The distribution of town-level intercepts has its mean at 0.32 and a standard deviation of 0.23. 

Table: Marginal parameter 95% credibility intervals for varying intercepts model of number of defensible space behaviors adopted by a household. $\alpha$ represents the (town-level) mean intercept (of $logit(p)$) and $\sigma$ the standard deviation of the distribution of town-level $\alpha$'s.

|                                 | Mean  |  SD  | Lower 95% CI | Upper 95% CI |
|:--------------------------------|:-----:|:----:|:------------:|:------------:|
|$\beta_{P}$                      | -0.06 | 0.04 |    -0.14     |     0.03     |
|$\beta_{E}$                      | 0.52  | 0.05 |     0.43     |     0.61     |
|$\beta_{R}$                      | -0.06 | 0.04 |    -0.15     |     0.02     |
|$\beta_{D}$                      | -0.05 | 0.05 |    -0.15     |     0.04     |
|$\alpha$                         | 0.32  | 0.12 |     0.07     |     0.55     |
|$\sigma$                         | 0.23  | 0.14 |     0.03     |     0.50     |
|$\alpha_{Alpine}$                | 0.55  | 0.09 |     0.38     |     0.72     |
|$\alpha_{Campo}$                 | 0.22  | 0.15 |    -0.10     |     0.50     |
|$\alpha_{Descanso}$              | 0.40  | 0.14 |     0.12     |     0.67     |
|$\alpha_{El Cajon-Lakeside}$     | 0.35  | 0.12 |     0.12     |     0.58     |
|$\alpha_{Pine Valley-Boulevard}$ | 0.11  | 0.23 |    -0.36     |     0.50     |
|$\alpha_{Ramona}$                | 0.37  | 0.06 |     0.25     |     0.49     |
|$\alpha_{Santa Ysabel-Julian}$   | 0.26  | 0.14 |    -0.03     |     0.53     |


### Generating Agents

We now demonstrate how we can use the model to simulate agents. First, as a model check and demonstration of the process, we simulate new agents based on the responses of the 637 survey respondents. We then modulate the values of several predictors to show how we can use the process to simulate behavioral interventions. 

For 30 survey respondents sampled at random, Figure 2 shows the distribution of model-predicted defensible space behaviors with their actual number of defensible space behaviors. Note that the model preserves substantial uncertainty around how many behaviors a household adopts, and that the level of uncertainty depends on the predictor values (for example a house in a town for which less data is available will have greater uncertainty).

```{r, fig.cap = "For 30 survey respondents sampled randomly, red diamonds are empirical number of defensible space behaviors, and violin plots reflect the distribution of model-implied behaviors for simulated households with the same set of predictor values."}
m = readRDS("../data/derived/varyInterceptModel.RDS")
set.seed(3957)
sims = sim(m, data = d)
samp = sample(nrow(d), 30)
empDF = data.frame(key = paste0("V", samp), obsValue = d$numBehaviors[samp])
# ord = empDF$key[order(empDF$value)]
simDF = as.data.frame(sims)[, samp] %>%
  gather()
df = left_join(simDF, empDF, by = "key") 

ggplot(df, aes(reorder(key, obsValue), y = value)) +
  geom_violin(fill = "gray") +
  geom_point(aes(y = obsValue), shape = 18, color = "red", size = 4) +
  scale_x_discrete(name = "Household", breaks = 0) +
  ylab("Number of defensible space behaviors")

```

We now simulate outcomes for two scenarios: One where perceived effectiveness of defensible space increases and one where perceived risk increases. In both cases the increase is a stochastic process, drawn from a normal distribution with mean two and standard deviation one (on the scaled-predictor scale). The modeled effect on defensible space behavior is presented in Figure 3.

```{r, fig.cap = "Effect of an increase in perceived risk of fire or perceived effectiveness of defensible space behavior on model-predicted number of defensible space behaviors. Green violins show the distribution of model-implied number of DS behaviors by town. Red and purple violins, respectively, show model implied number of DS behaviors with every individual in the population having had an increase in their perception of risk or effectiveness."}
meanBump = 2
noise = 1
simOrig = sim(m)
dEff = d
dEff$effectiveness = dEff$effectiveness + rnorm(nrow(d), meanBump, noise)
simEff = sim(m, data = dEff)
dRisk = d
dRisk$risk = dRisk$risk + rnorm(nrow(d), meanBump, noise)
simRisk = sim(m, data = dRisk)

gatherSims = function(sims, label, cities = d$city) {
  sims = as.data.frame(sims)
  colnames(sims) = paste0(cities, 1:length(cities))  # for uniqueness
  sims$simulation = label
  gathered = gather(sims, key, value, -simulation)
  gathered$key = gsub("[[:digit:]]", "", gathered$key) 
  gathered
}

sims = 
  rbind(
    gatherSims(simOrig, "Original"),
    gatherSims(simEff, "Effectiveness Boost"),
    gatherSims(simRisk, "Risk Perception Boost")
  )
head(sims)

sims$simulation = factor(sims$simulation, levels = c("Original",
                                                     "Risk Perception Boost",
                                                     "Effectiveness Boost"))
ggplot(sims, aes(x = key, y = value, fill = simulation)) + 
  geom_violin(position = position_dodge(width = .5)) +
  scale_fill_brewer(palette = "Dark2") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position = "top", legend.direction = "horizontal") +
  ylab("Number defensible space behaviors") +
  xlab("")
```

## Discussion

### Substance of what we found (Katie and/or Kenny)

How does it fit with other DS behavior research? With other findings from this survey?

### How the ABM stuff works and will fit into ABM and coupled model (Mike)

## References