---
title: "Empirical generation of agent population for a coupled model of fire in the wildland-urban interface"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: pdf_document
bibliography: fireFringe.bib
---

```{r setup, include = FALSE}
library(rethinking)
library(dplyr)
library(tidyr)
library(ggplot2)
theme_set(new = theme_bw())
d = readRDS('../data/derived/dataVImodel.RDS') %>% as.data.frame()
knitr::opts_chunk$set(fig.pos = 'H!', echo = FALSE, results = "hide", warning = FALSE)
```

## Introduction

### Broad Justification: WUI fire is a problem and we need models that include society (Katie)

Already a problem, getting worse with climate change, DS behavior matters for the owner and broader fire patterns, therefore we need models that include homeowner behavior.

### ABM Justification (Patrick)

Most models omit humans, econ models of behavior assume rational self-interest but that fails to capture key dynamics in collective action challenges like this. ABMs to the rescue: can capture social dynamics with agents responding to each other and can capture biophysical -> social feedback with agents responding to events in their environment.

### Broad overview of our larger endeavor (Kenny?)
### May need refinement to go along with Katie and Patrick's section and to align it with interpretation of results and discussion

- Set out to build coupled model of fire and society. 
- Located in San Diego because fire is big problem, potential for action, etc
- Full model situates homeowners on the landscape, simulates ignition and spread w/ homeowners responsive to social environment and fire experience, etc.
    - DS behavior empirically parameterized based on survey responses

Shifting dynamics (e.g., climate change) between interacting social and ecological systems can intensify previously benign phenomena or create novel threats to both humans and the natural environment (Moritz et al., 2014; Paveglio & Prato, 2011). For example, in recent decades, the southern California region, has experienced increasing frequency of and threat of losses from wildfire (California Department of Forestry and Fire Protection [CAL FIRE], 2000; Keeley et al. 1999; Syphard et al., 2007a), which is attributable to both social processes-i.e., urban expansion and the patterns of residential development coupled with forest management and fire suppression-and ecological conditions-i.e., seasonal weather events, topography, and climate change (Syphard et al., 2005, 2007a, 2007b, 2008).

However, few coupled human-natural systems studies employing agent-based models have sought to understand socio-environmental dynamics by parameterizing agents with empirically derived survey data from the area being studied and the landscape on which agents will be modeled. This study integrates various measures related to southern California residents' experience with wildfire, perceptions of wildfire, and defensible space behavior to parameterize agents. Here, we do not aim to document the complete mechanics of the agent-based model. That description is forthcoming and will comply with the ODD protocol (cite). The purpose of this paper, as part of this larger ongoing agent-based modeling project coupling human-wildfire dynamics, is to describe the motivation for, mechanics of, and findings from an empirical parameterization of agent-behavior. This parameterization, based on survey data, uses a multi-level Bayesian model to quantify and preserve uncertainty in human behavior and provides XYZ

### Description of the system (Kenny)
### Study area

The study area encompasses portions of San Diego County, CA, USA surrounding the southern extent (i.e., Descanso Ranger District) of the Cleveland National Forest (CNF) located in San Diego County, California, USA. This topographically diverse area, with high levels of biodiversity and urban development, experiences a Mediterranean climate characterized by cool, wet winters and long summer droughts. The native chaparral shrublands dominating this fire-adapted, fire-prone ecosystem are extremely flammable during the late summer and autumn. When ignited, these shrublands burn in high-intensity, stand-replacing crown fires, exacerbated by the accompanying Santa Ana winds. Since the mid-1900s an average of 500 homes are lost annually to wildfire, with that rate doubling since 2000 (Calfire, 2000). In 2003 and 2007, San Diego County experienced major wildfire losses (Keeley et al. 2009), and major wildfire events are projected to continue as fire frequency increases (Keeley et al. 1999; Syphard et al., 2007). San Diego County has a population of more than three million residents, with a projected growth of one million more by 2030 (SANDAG, 2008). While most residential growth is concentrated along the coast, housing development continues eastward, toward CNF. This wildland-urban interface (WUI), which we term the San Diego-Cleveland National Forest wildland-urban interface (SDCNF-WUI), covers several thousand hectares of interspersed urban development and shrubland.

- Previous findings from this survey?

- (or define wui parameters and references if different from Hammer et al., 2007).

### What is known about the drivers of DS behavior (Katie)

Particuarly, here we need to justify our use the effectiveness and risk constructs. Plus anything that can be said about social influences and proximity to fire is extra great.

### Two-step process: generation & updating (Mike)

Two tasks for a working ABM: defining the population and their initial behavior (static) and updating their behavior (dynamic, function of physical and social environment).

We have cross-sectional survey data which provides an empirical foundation on which to build the population of agents. Data at a single timepoint cannot inform the dynamic updating process, so our updating is based on theory from the fire behavior literature. We defer a full descriptoin of agents' updating rules to the documentation of the coupled model but note that it employs a decision heuristic that incorporates social feedback in the form of the overall adoption rate in the agent's town and biophysicial feedback in the form of proximity to recent fire, as well as cognitive variables that prior research has demostrated are important predictors of the adoption of DS behavior. The cognitive and town-adoption variables used in the updating rules are the same as those used here in the generation of the population of agents.

### Model for agent generation (Mike)

Here, we describe the motivation for, mechanics of, and findings from a survey-data-based empirical generation of a population of agents for a CHANS model. The parameterization is based on survey data and employs a Bayesian, multi-level model that quantifies and preserves uncertainty in human behavior and provides a natural, principled mechanism for generating agents.

Heterogeniety in behavior at town-level, don't want to ignore, but fixed effects over-learn. Pooling is awesome, quantifies uncertainty incorporating sample size, so we can do something principled in towns where we have few observations. Cite predictive benefits.

Generative aspect: Is there anything unique about Bayesian here? Don't have to make distributional assumption about posterior.

We identify households in the SDCNF using housing parcel data from the San Diego Association of Goverments (SANDAG) Geographic Information System (GIS). The source dataset includes all parcels in San Diego County as of February 1, 2016, from which we extracted those parcels labeled as single-family households. To generate an agent at each household location, we draw a set of predictor values from the ECDF (or maybe we have to make some distributional assumption to define a multivariate distribution to sample from), draw a set of parameters from the model's posterior distribution, and simulate a binomial trial to determine the number of DS behaviors that agent has adopted at the model initialization. We now describe this process in detail.

## Methods

### Data details (Kenny)

Data from SDCNF-WUI residents of single-family detached homes (N = 637) used to initially parameterize agents was collected in 2008 as part of a larger study focused on the human dimensions of wildfire and public's perceptions of wildfire management (Kyle et al., 2010). The larger study collected data on, among other variables, residents' experience with wildfire, current and past defensible space (home protection) behavior, attitude towards defensible space practices, intention to practice defensible space in the future, value orientations, attitude towards wildfire management agencies, trust in and credibility of wildfire management, perceived risk of wildfire.

#### Constructed variables (Katie)

What questions were grouped into our risk and effectiveness variables and why. If you want to get into factor analysis, great, but a theoretical justification would probably suffice.

### WUI details

We identified households in the WUI by selecting those parcels whose Assessor Info Zone filed was labeled as "SINGLE FAMILY RESIDENTIAL" in the SANDAG GIS parcel layer as mentioned above (cite metadata parcels.pdf). As the SADNAG GIS database does not contain building footprints, we approximated single-family houses on the landscape using the ArcPy extensions of ArcGIS 10.3. For each single-family parcel in the dataset, the ArcPy script calculates: (1) the centoid of the parcel (constrained within the original geometry), (2) a buffer with a 30 foot radius, approximating the footprint of a hosue wiht a median home size for construction in the Western US (cite http://www.census.gov/construction/chars/pdf/c25ann2014.pdf, p. 345), and (3) a 100 foot buffer of the home and within the bounds of the original pacel, corresponding to the zone of defensible space managed by that homeowner. The script is publicly available under the MIT license at https://github.com/pjbitterman/fotf_public/. Metadata from the source file were then joined with the derived files, linking the housing footprints to data required by the statistal model (e.g., city location, distance to fire). As our generated homes included all single-family residences in San Diego County, we created a subset of homes in the WUI by ..... <<I have no idea what we've decided on>>. %%here would be additioanl details that reference the Radeloff paper and the SILVIS lab data where I grabbed the WUI data from.%%


### Model fitting (Mike)

- Note to self: Take out fire distance, maybe do formal model comparison and model averaging. Model comparison, m4 without distance; m5 without policy beliefs:

     WAIC pWAIC dWAIC weight    SE  dSE
m5 3287.5   7.8   0.0   0.46 30.38   NA
m4 3288.1   8.8   0.6   0.34 30.45 2.62
m3 3289.0   9.2   1.6   0.21 30.53 3.42

To empirically parameterize homeowner-agent behavior, we conditioned a multi-level Bayesian statistical model on data from 637 homeowner survey respondents. We then use the model to generate new households drawn from the distribution implied by the model. The outcome variable of the model is the number of defensible space practices adopted by each homeowner, which we instantiate as a binomially distributed process. The model contains varying intercepts at the level of town ($\alpha_{town}$), which allows the model to pool information across towns in determining the base adoption rate and models the effect of social forces on homeowner behavior. Experience with fire is included as a predictor as the natural logarithm of the distance of the home from recent fires ($D$). Three additional predictors were constructed from survey responses to charactarize the psychological makeup of homeowners: policy beliefs ($P$), beliefs about the effectiveness of defensible space practices ($E$), and beliefs about risk associated with wildfire ($R$). We employed weakly regularizing prior, $\mathcal{N}(0, 1)$, for all four continuous predictors to reign-in overfitting. The model takes the form:

$$
\begin{aligned}
N_i &\sim binomial(4, p_i) \\
logit(p_i) &= \alpha_{town[i]} + \beta_{P} P + \beta_{E} E + \beta_{R} R + \beta_{D} ln(D) \\
\alpha_{town} &\sim Normal(\alpha, \sigma) \\
\alpha &\sim Normal(0.5, 1) \\
\sigma &\sim HalfCauchy(0, 2) \\
\beta_{P} &\sim Normal(0, 1) \\
\beta_{E} &\sim Normal(0, 1) \\
\beta_{R} &\sim Normal(0, 1) \\
\beta_{D} &\sim Normal(0, 1). \\
\end{aligned}
$$

All analyses were performed in R version 3.3.1 [@r_core_team_r:_2016]. For statistical modeling, we used the rethinking package [@mcelreath_rethinking:_2015] which samples posterior distributions using Hamiltonian Monte Carlo via Stan [@stan_development_team_stan:_2015]. The full reproducability suite of data and code are available in a repository at XXX (xxx.com). 

### Populating the model (Mike)

- Defining joint distribution of predictors for each town

*Rewrite this to match what we're doing now: for each house, draw one set of predictors and one set of parameters and generate a $p$.* Bayesian models are generative, and we now describe how we use the model to generate new agent-households. For any set of predictor values, there is an implied distribution of defensible space behaviors. This distribution is generated by drawing (1,000) samples of parameter values from the model's joint posterior distribution, multiplying the vectors of paramter values by a vector of predictor values to obtain a distribution of $p$ values, which are then used in binomial trials to generate a distribution of number of defensible space behaviors. Note the two levels of stochasticity in this process: 1 in drawing parameters from the joint posterior distribution and another in the binomial trials for each $p$. This preserves uncertainty around defensible space behavior. There is a large stochastic element to how many behaviors a given household will implement, and this method quantifies and preserves the uncertainty in that stochasticity. 

This process works for any set of predictor values. In a presumed-stationary world, we could generate new agents from the observed sets of predictor values or a multivariate distribution parameterized from the observed data. To test the effects of interventions, we could modulate the values of specific predictors, for example, increasing the values of effectiveness of defensible space behavior by some fixed or random value to understand how an education-outreach effort might work. The varying intercepts aspect of the model also opens the possibility of generating new towns in a princpled manner, as long as we are willing to posit that the new towns come from the same distribution as the observed towns. To do so, we draw values of $\alpha_{town}$s from the posterior distribution of $\alpha$.


## Results

### Summary Statistics

Figure 1 shows the distribution of number of defensible space behaviors, out of four possible, adopted per household by town. Across all towns, the modal number of behaviors adopted is four,the median is two, and the mean `r round(mean(d$numBehaviors), 2)`. Figure 1 also shows the number of survey responses in our dataset from each town, which are roughly proportional to the number of homes in the WUI in each town.

```{r, fig.height = 4.5, echo = FALSE, fig.cap = "Number of defensible space behaviors adopted by town. Tile heights are proportional to the number of survey respondents per town, and widths are proportional to the number of people in that town having adopted that many behvaiors."}
# ggplot(d, aes(fill = as.factor(numBehaviors), 
#               x = reorder(city, city, function(x) length(x)))) + 
#   geom_bar() + 
#   scale_fill_discrete(guide = guide_legend(title = "Number Bevahiors", reverse = TRUE)) +
#   xlab("Town") +
#   ylab("Number of households")
# 
# head(d$city)
# d$city = factor(d$city, levels = levels(reorder(d$city, d$city, function(x) length(x))))
# ggplot(d, aes(x = numBehaviors)) + 
#   geom_histogram(bins = 5) +
#   facet_wrap(~ city)
# 
# ggplot(d, aes(x = numBehaviors, fill = city)) + 
#   geom_bar(position = "dodge")

mosaicplot(table(reorder(d$city, d$numBehaviors, mean), 
           factor(d$numBehaviors, levels = 4:0)), 
     main = "", color = TRUE, dir = c("h", "v"),
     las = 1)
```

### Model Coefficients

Table 1 presents parameter values and 95% credibility intervals for each of the predictors in the model. Belief in the effectiveness of defensible space behaviors is a strong positive predictor of implementation of defensible space behavior. Policy beliefs, which is an aggregate measure capturing ???, and perceived risk associated with wildfire are both negatively associated with defensible space adoption, but there is ambiguity around those relationships. Individuals who are closer to recent fires tend to have adopted more defensible space behavior, but this relationship also has significant uncertainty. There is substantial town-to-town variability in the base-rate of adoption: The distribution of town-level intercepts has its mean at 0.32 and a standard deviation of 0.23. 

Table: Marginal parameter 95% credibility intervals for varying intercepts model of number of defensible space behaviors adopted by a household. $\alpha$ represents the (town-level) mean intercept (of $logit(p)$) and $\sigma$ the standard deviation of the distribution of town-level $\alpha$'s.

|                                 | Mean  |  SD  | Lower 95% CI | Upper 95% CI |
|:--------------------------------|:-----:|:----:|:------------:|:------------:|
|$\beta_{P}$                      | -0.06 | 0.04 |    -0.14     |     0.03     |
|$\beta_{E}$                      | 0.52  | 0.05 |     0.43     |     0.61     |
|$\beta_{R}$                      | -0.06 | 0.04 |    -0.15     |     0.02     |
|$\beta_{D}$                      | -0.05 | 0.05 |    -0.15     |     0.04     |
|$\alpha$                         | 0.32  | 0.12 |     0.07     |     0.55     |
|$\sigma$                         | 0.23  | 0.14 |     0.03     |     0.50     |
|$\alpha_{Alpine}$                | 0.55  | 0.09 |     0.38     |     0.72     |
|$\alpha_{Campo}$                 | 0.22  | 0.15 |    -0.10     |     0.50     |
|$\alpha_{Descanso}$              | 0.40  | 0.14 |     0.12     |     0.67     |
|$\alpha_{El Cajon-Lakeside}$     | 0.35  | 0.12 |     0.12     |     0.58     |
|$\alpha_{Pine Valley-Boulevard}$ | 0.11  | 0.23 |    -0.36     |     0.50     |
|$\alpha_{Ramona}$                | 0.37  | 0.06 |     0.25     |     0.49     |
|$\alpha_{Santa Ysabel-Julian}$   | 0.26  | 0.14 |    -0.03     |     0.53     |


### Generating Agents

We now demonstrate how we use the statistical model to simulate agents. First, as a model check and demonstration of the process, we simulate 637 mock-agents based on the responses of the 637 survey respondents. We then populate the model landscape with 20,000 agents, each located at a the location of a household, from the joint distribution of predictor values implied by the survey and the model results.

For 30 survey respondents sampled at random, Figure 2 shows the distribution of model-predicted defensible space behaviors with their actual number of defensible space behaviors. Note that the model preserves substantial uncertainty around how many behaviors a household adopts, and that the level of uncertainty depends on the predictor values (for example a house in a town for which less data is available will have greater uncertainty).

```{r, fig.cap = "For 30 survey respondents sampled randomly, red diamonds are empirical number of defensible space behaviors, and violin plots reflect the distribution of model-implied behaviors for simulated households with the same set of predictor values."}
m = readRDS("../data/derived/varyInterceptModel.RDS")
set.seed(3957)
sims = sim(m, data = d)
samp = sample(nrow(d), 30)
empDF = data.frame(key = paste0("V", samp), obsValue = d$numBehaviors[samp])
# ord = empDF$key[order(empDF$value)]
simDF = as.data.frame(sims)[, samp] %>%
  gather()
df = left_join(simDF, empDF, by = "key") 

ggplot(df, aes(reorder(key, obsValue), y = value)) +
  geom_violin(fill = "gray") +
  geom_point(aes(y = obsValue), shape = 18, color = "red", size = 4) +
  scale_x_discrete(name = "Household", breaks = 0) +
  ylab("Number of defensible space behaviors")

```

**Mike:**

For each town, define joint distribution of predictors. For each of the 20k homes, draw predictor values from the joint distribution and simulate a number of behaviors.

Generate a pair of maps: household points colored by number of behaviors; one surveyed homes with empirical number, other all 20k with generated number.


## Discussion

### Substance of what we found (Katie and/or Kenny)

How does it fit with other DS behavior research? With other findings from this survey?

### How the ABM stuff works and will fit into ABM and coupled model (Mike and/or Patrick)

## References